---

---

<style>
    .container {
        display: flex;
        flex-direction: row;
        gap: 8px;
        width: 220px;
        height: 220px;
        margin: 16px;
        form {
            width: 60%;
        }
        .col-2 {
            width: 40%;
        }
    }
    #captchaContainer {
        display: flex;
        flex-wrap: wrap;
        width: 400px;
        height: 400px;
        border: 1px solid black;
        overflow: scroll;
    }
    .zone {
        background-color: black;
        width: 120px;
        height: 120px;
        color: white;
        background-size: cover;
    }
    .selected {
      -webkit-box-shadow:inset 0px 0px 0px 5px #000;
      -moz-box-shadow:inset 0px 0px 0px 5px #000;
      box-shadow:inset 0px 0px 0px 5px #000;
    }
    .hidden {
        display: none !important;
    }
</style>
<br/>
<button id="actionButton">Soy serrano</button>
<p>Para enviar el formulario de contacto, demuestra que eres serrano</p>
<a id="close">Close</a>
<a id="open">Open</a>
<div id="captchaContainer" class="container hidden">
    <div class="zone"></div>
</div>

<script>
    import { actions } from 'astro:actions';
    const clickable1 = document.getElementById("zone1");
    const clickable2 = document.getElementById("zone2");
    const clickable3 = document.getElementById("zone2");
    const closeBtn = document.getElementById("close");
    const openBtn = document.getElementById("open");
    const container = document.getElementById("captchaContainer");
    const passkey = new Array();

    const images = [
      'anis',
      'beach1',
      'beach2',
      'beach3',
      'mezquita',
      'beach4',
      'bellota',
      'building',
      'city1',
      'gallipiernos',
      'guarros',
      'trafficjam',
      'trafficjam2',
      'trafficjam3',
      'trafficjam4'
    ];

    images.map((image,idx,all) => {
        const div = document.getElementsByClassName("zone")[0];
        // duplicate element div
        const newDiv = div.cloneNode(true);
        //remove div from document
        //newDiv.textContent = key;
        newDiv.style.backgroundImage = `url(src/assets/images/captcha/${image}_240.png)`;
        newDiv.dataset.value = image;
        newDiv.addEventListener("click", handleChoice);
        container?.appendChild(newDiv);
        // no entiendo por quÃ© pero funciona
        if(idx===1){
          container?.removeChild(div);
        }
    });

    clickable1?.addEventListener("click", handleChoice);
    clickable2?.addEventListener("click", handleChoice);
    closeBtn?.addEventListener("click", closeContainer);
    openBtn?.addEventListener("click", openContainer);

    async function closeContainer() {
        container?.classList.add("hidden");
    }
    async function openContainer() {
        container?.classList.remove("hidden");
    }

    async function handleChoice(e: MouseEvent) {
        const target = e.target as HTMLElement;
        const choice = target.dataset.value;
        if (target?.classList.contains('selected')) {
            target.classList.remove("selected");
            removeChoice(choice)
            return;
        } else {
          target.classList.add("selected");
        }
        passkey.push(choice);
        console.log(passkey)
        const form = document.querySelector("form");
        if (!form) return;
        const data = new FormData(form as HTMLFormElement);
        /*
        data.append("captcha", passkey.join(""));
        const response = await fetch(form.action, {
            method: form.method,
            body: data,
        });
        */
    }

    function removeChoice(choice: string) {
        const index = passkey.indexOf(choice);
        if (index > -1) {
            passkey.splice(index, 1);
        }
    }
    const button = document.getElementById('actionButton');
    button?.addEventListener('click', async () => {
      const { data, error } = await actions.getGreeting({ name: passkey.join(",") });
      if (error) {
        console.error(error);
        return;
      }
      console.log(data)
    });
</script>
